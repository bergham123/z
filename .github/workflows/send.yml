name: WhatsApp Bot Send

on:
  workflow_dispatch:

jobs:
  send-messages:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo (Restores Session)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # â”€â”€â”€ 1. Start Bot in Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Bot
        run: npm start &
        # The '&' allows this step to finish so the next one runs immediately

      # â”€â”€â”€ 2. Wait and Check if QR is Needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check Authentication Status
        id: check_auth
        run: |
          echo "Waiting 15 seconds for WhatsApp handshake..."
          sleep 15
          
          if [ -f ./qr.png ]; then
            echo "::notice::SESSION INVALID! QR Code generated."
            echo "::notice::Go to 'Artifacts' (bottom of this page) to scan."
            echo "needs_scan=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::SESSION VALID! No scan needed."
            echo "needs_scan=false" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€ 3. Upload QR (Only if needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload QR Code
        if: steps.check_auth.outputs.needs_scan == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: whatsapp-qr-code
          path: ./qr.png
          retention-days: 1

      # â”€â”€â”€ 4. Pause for User to Scan (Only if needed) â”€â”€â”€â”€â”€â”€â”€
      # If QR exists, we wait indefinitely until user scans and bot becomes ready
      - name: Waiting for User to Scan...
        if: steps.check_auth.outputs.needs_scan == 'true'
        run: |
          echo "â³ Waiting for you to scan the QR code..."
          echo "The script is running in the background. Once scanned, it will proceed."
          
          # Monitor if qr.png disappears (bot deletes it on success) or check logs
          # Simple wait is enough because the bot keeps running
          sleep 300 # Wait up to 5 mins for scan

      # â”€â”€â”€ 5. Wait for Bot to Finish Sending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Monitor Bot Progress
        run: |
          echo "ğŸ¤– Bot is working. Monitoring logs..."
          # 'wait' waits for the background process (npm start) to finish
          wait

      # â”€â”€â”€ 6. Save Updated Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Save Session & Progress
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add Session (force add in case it's in gitignore)
          # If session was expired, this saves the NEW valid one
          git add -f .wwebjs_auth
          
          git add progress.json messages.txt
          git commit -m "Update session/progress [skip ci]" || echo "No changes"
          git push
