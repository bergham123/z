name: WhatsApp Bot Send

on:
  workflow_dispatch: # Trigger manually from GitHub Actions tab

jobs:
  send-messages:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Give enough time to scan QR

    steps:
      # ─── Checkout repo (Restores previous Session) ──────
      - name: Checkout repo
        uses: actions/checkout@v4

      # ─── Setup Node.js ───────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ─── Install dependencies ────────────────────────────
      - name: Install dependencies
        run: npm install

      # ─── Run WhatsApp bot (Background) ──────────────────
      # We run it in background so we can check for the QR file
      - name: Run bot
        run: npm start &
      
      # ─── Handle QR Code (First Run Only) ─────────────────
      - name: Wait for QR Code
        run: |
          echo "Waiting for bot to generate QR..."
          # Wait up to 60 seconds for qr.png to appear
          timeout 60s bash -c "until [ -f ./qr.png ]; do sleep 1; done"
          echo "QR Code found!"
      
      - name: Upload QR Code
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: qr-code
          path: ./qr.png
          retention-days: 1

      # ─── Wait for Bot to Finish Work ─────────────────────
      # Now we bring the background process to foreground to see logs
      - name: Wait for messages to send
        run: |
          echo "Bot is running. Scan the QR if this is the first time."
          echo "Waiting for process to finish..."
          wait

      # ─── Save Session (The "Save Game") ───────────────────
      # This saves the folder so you NEVER have to scan again
      - name: Save Session & Progress
        if: always() # Run even if there are errors
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add the session folder (using -f because it might be ignored)
          # .wwebjs_auth is the folder where LocalAuth saves the token
          git add -f .wwebjs_auth
          
          # Add progress and logs
          git add progress.json messages.txt
          
          # Commit
          git commit -m "Update session and progress [skip ci]" || echo "No changes to commit"
          
          # Push
          git push
